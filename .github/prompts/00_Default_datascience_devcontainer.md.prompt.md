---
mode: agent
---
# GitHub Copilot Prompt: Scaffold a Reproducible Python DS/LLM Environment (Codespaces + Dev Container + venv + pip-tools)

> **Objective:** Generate a complete, working scaffold for a Python data‑science/LLM project that runs reproducibly in **GitHub Codespaces** using a **Dev Container** (Dockerfile) with a project‑local **venv**, **pip‑tools** locking, and a **Makefile**. Provide minimal **tests** so `make test` passes on first run.

---

## Outcomes

Copilot, please create the following **file tree** and **file contents** exactly as specified. The project must build and test successfully in GitHub Codespaces automatically.

```
.
├─ .devcontainer/
│  ├─ devcontainer.json
│  ├─ Dockerfile
|  ├─ requirements.in
|  ├─ requirements-dev.in 
├─ src/
│  └─ your_project/
│     ├─ __init__.py
│     └─ app.py
├─ tests/
│  └─ test_app.py
├─ requirements.txt           # generated by pip-compile
├─ requirements-dev.txt       # generated by pip-compile
├─ pyproject.toml
├─ Makefile
├─ .pre-commit-config.yaml
├─ .gitignore
└─ README.md
```

---

## 1) Dev Container

**.devcontainer/devcontainer.json**
```json
{
  "name": "py-ds-llm-env",
  "build": { "dockerfile": "Dockerfile" },
  "features": {
    "ghcr.io/devcontainers/features/common-utils:2": {},
    "ghcr.io/devcontainers/features/git:1": {}
  },
  "customizations": {
    "vscode": {
      "extensions": [
        "ms-python.python",
        "ms-python.vscode-pylance",
        "ms-toolsai.jupyter",
        "charliermarsh.ruff",
        "github.vscode-github-actions"
      ]
    }
  },
  "postCreateCommand": "make bootstrap"
}
```

**.devcontainer/Dockerfile**
```dockerfile
FROM python:3.12-slim

# System libs commonly needed by DS/LLM projects
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential git curl ca-certificates \
    libssl-dev libffi-dev pkg-config \
    && rm -rf /var/lib/apt/lists/*

# (Optional) git-lfs (large-file support) for models/datasets - keep Dockerimage small until needed
# RUN curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | bash && \
#    apt-get update && apt-get install -y git-lfs && git lfs install && \
#    rm -rf /var/lib/apt/lists/*

WORKDIR /workspace
ENV PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1
    
# Create an isolated venv inside the container
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Upgrade pip + install build tooling + pip-tools
# note the explicit path to the venv
RUN /opt/venv/bin/pip install --upgrade pip wheel setuptools pip-tools

# Compile lock files and install will be run by Makefile (make bootstrap)
# as part of the postCreateCommand.  
# This Dockerfile is only used to construct the base image during development.
# Additional dependencies can be added during development using 
# requirements.in.txt, requirements-dev.in.txt (this directory) and then
# make lock && make sync.
# For production, construct a new Dockerfile based of the final configuration.
```

> **Note:** If the project later needs heavy native deps (CUDA/GDAL/etc.), switch to a Mambaforge base image; keep the rest of the pattern unchanged.

---

## 2) Dependency Inputs

**requirements.in**
```txt
# Runtime deps (examples suitable for DS/LLM scaffolds)
fastapi
uvicorn
httpx
pydantic
numpy
pandas
```

**requirements-dev.in**
```txt
pytest
pytest-cov
ruff
mypy
pre-commit
tox
```

Leave `requirements.txt` and `requirements-dev.txt` **untracked initially** (or generated the first time via the Docker build / Makefile).

---

## 3) Project Metadata & Tooling

**pyproject.toml**
```toml
[project]
name = "your-project"
version = "0.1.0"
description = "DS/LLM project scaffold with reproducible env"
readme = "README.md"
requires-python = ">=3.10"
authors = [{ name = "Ian Donaldson" }]

[tool.ruff]
line-length = 100

[build-system]
requires = ["setuptools>=61.0.0"]
build-backend = "setuptools.build_meta"
```

**.pre-commit-config.yaml**
```yaml
repos:
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.6.9
    hooks:
      - id: ruff
        args: [--fix]
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.10.0
    hooks:
      - id: mypy
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.6.0 # or latest stable
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
```

**.gitignore**
```gitignore
# Python
__pycache__/
*.pyc
*.pyo
*.pyd
*.coverage
.pytest_cache/
.mypy_cache/

# Environments
.venv/
env/
venv/

# Tools
.coverage
htmlcov/

# Lock files (generated)
requirements.txt
requirements-dev.txt

# VS Code / Devcontainers
.vscode/
.devcontainer/.cache/
```

---

## 4) Makefile (repeatable commands)

**Makefile**
```make
SHELL := /bin/bash
VENV_BIN := /opt/venv/bin
PY := $(VENV_BIN)/python
PIP := $(VENV_BIN)/pip
PIP_COMPILE := $(VENV_BIN)/pip-compile
PIP_SYNC := $(VENV_BIN)/pip-sync

bootstrap:
	$(PIP_COMPILE) ./.devcontainer/requirements.in -o requirements.txt
	$(PIP_COMPILE) ./.devcontainer/requirements-dev.in -o requirements-dev.txt
	$(PIP) install -r requirements.txt -r requirements-dev.txt
	pre-commit install

lock:
	$(PIP_COMPILE) ./.devcontainer/requirements.in      -o requirements.txt
	$(PIP_COMPILE) ./.devcontainer/requirements-dev.in  -o requirements-dev.txt

sync:
	$(PIP_SYNC) requirements.txt requirements-dev.txt

test:
	pytest

lint:
	ruff check .
	mypy --ignore-missing-imports .

run:
	$(PY) -m uvicorn src.your_project.app:app --host 0.0.0.0 --port 8000

update:
	$(PIP) list --outdated
```

---

## 5) Minimal App + Tests

**src/your_project/__init__.py**
```python
__all__ = ["app"]
```

**src/your_project/app.py**
```python
from fastapi import FastAPI

app = FastAPI(title="Your Project API")

@app.get("/healthz")
def healthz():
    return {"status": "ok"}

@app.get("/add")
def add(a: int, b: int):
    return {"sum": a + b}
```

**tests/test_app.py**
```python
from fastapi.testclient import TestClient
from src.your_project.app import app

client = TestClient(app)

def test_healthz():
    res = client.get("/healthz")
    assert res.status_code == 200
    assert res.json() == {"status": "ok"}

def test_add():
    res = client.get("/add", params={"a": 2, "b": 3})
    assert res.status_code == 200
    assert res.json()["sum"] == 5
```

---

## 6) README

**README_prompt.md**
```markdown
# Your Project (DS/LLM Reproducible Scaffold)

Reproducible dev via **Dev Container + venv + pip-tools**. Designed for **GitHub Codespaces** and portable to other clouds.

## Quickstart (Codespaces)

1. Open in Codespaces; the Dev Container builds automatically.
2. Dependencies are compiled & installed via `make bootstrap` (triggered by `postCreateCommand`).
3. Run tests: `make test`
4. Lint & type-check: `make lint`
5. Start API: `make run` then open <http://localhost:8000/healthz>

## Dependency Workflow

- Add a dependency to `requirements.in` (or `requirements-dev.in`).
- Rebuild lock files: `make lock`
- Sync the environment: `make sync`
- Commit: `requirements.in`, `requirements-dev.in`, lock files (optional), and all source files.
```

---

## Acceptance Criteria

- Codespaces should successfully build the Dev Container and run `make bootstrap`.
- `make test` must pass out of the box (FastAPI healthcheck & add endpoint).
- `make lint` runs ruff + mypy without error (ignore-missing-imports is acceptable).
- `make run` exposes an API on port 8000 with `/healthz` and `/add` endpoints.
- Locking is handled by **pip-tools** (pip-compile) and can be regenerated via `make lock`.
- The environment is reproducible based on the Dockerfile + devcontainer + lock files.
